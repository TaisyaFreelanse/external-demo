# Внешний API: загрузка мероприятий и мониторинг

## Назначение
- Принять готовые мероприятия от внешних сайтов через HTTP API и сохранить их в ядре системы мониторинга.
- Валидировать входные данные по тем же правилам, что действуют сегодня на внутреннем сайте.
- Вернуть понятные ответы об успехе либо о найденных ошибках.
- Обозначить дальнейшие шаги по встраиваемым виджетам мониторинга и персональной калькуляции.

## Аутентификация
- На первом этапе допускаем работу без авторизации (эндпоинт скрыт, используется только для интеграционных тестов).
- Запланировано: авторизация по ключу разработчика (`X-API-Key`) с привязкой к партнёру и ограничениям по правам.

## Базовые сущности
Поле | Тип | Обязательность | Описание
---|---|---|---
`title` | string | да | Название мероприятия.
`authorName` | string | да | Имя/псевдоним автора. Заполняется продюсером в свободной форме и отображается в интерфейсе без изменений.
`location` | string | да | Место проведения.
`seatLimit` | integer (>0) | да | Количество участников.
`pricePerSeat` | number (>0) | да | Цена одного места в рублях.
`startApplicationsAt` | ISO datetime | да | Контрольная точка `ti10`.
`endApplicationsAt` | ISO datetime | да | Контрольная точка `ti20`.
`startContractsAt` | ISO datetime | да | Контрольная точка `ti30`.
`startAt` | ISO datetime | да | Контрольная точка `ti40`, старт мероприятия.
`endAt` | ISO datetime | да | Контрольная точка `ti50`, окончание мероприятия.
`createdAtClient` | ISO datetime | да | Время, когда событие было создано на клиентском сайте (`t0`).
`timezone` | string (IANA) | да | Часовой пояс, в котором заданы контрольные точки (например, `Asia/Sakhalin`, `Europe/Moscow`). Используется для корректного отображения обратного отсчета и текущего времени в интерфейсе.
`producerCode` | string | да | Уникальный код продюсера (используется для прав доступа).
`producerName` | string | да | Отображаемое имя продюсера (как будет видно пользователям).
`description` | string | да | Краткое описание мероприятия.

> Фиксируем модель из семи точек: `t0` (создание), `ti10`, `ti20`, `ti30`, `ti40`, `ti50`, `uploadedAtServer`. Извещения остаются стандартными и не требуют загрузки отдельными структурами.

Дополнительно сервер рассчитывает:
- `priceTotal` = `seatLimit × pricePerSeat` (в копейках).
- `uploadedAtServer` = момент приема события (назначается автоматически).

### Статусы мероприятий и видимость
- **Черновик (`draft`)**: Мероприятие загружается в статусе черновика. Черновик виден только продюсеру-владельцу (по `producerCode`) для просмотра. Черновик можно многократно обновлять через API.
- **Опубликовано (`published`)**: После публикации мероприятие становится доступно всем пользователям платформы. Публикация выполняется отдельным запросом (см. эндпоинт `/api/external/events/publish`).

**Ограничения:**
- После наступления контрольной точки `ti20` (окончание приема заявок) нельзя загружать новые черновики и нельзя публиковать существующие черновики.

## Эндпоинты
### POST `/api/external/events`
Создание или обновление черновика мероприятия. При наличии `id` и совпадении владельца выполняется обновление. Если `id` отсутствует — создаем новый черновик.

**Важно:** Все мероприятия загружаются в статусе `draft` (черновик). Для публикации используйте отдельный эндпоинт `/api/external/events/publish`.

#### Пример запроса
```json
{
  "id": "evt_123",
  "title": "Кулинарный интенсив",
  "authorName": "Шеф Иванов",
  "location": "Москва, ул. Поварская, 12",
  "seatLimit": 12,
  "pricePerSeat": 7500,
  "startApplicationsAt": "2025-02-01T09:00:00+03:00",
  "endApplicationsAt": "2025-02-10T21:00:00+03:00",
  "startContractsAt": "2025-02-12T10:00:00+03:00",
  "startAt": "2025-02-20T12:00:00+03:00",
  "endAt": "2025-02-20T18:00:00+03:00",
  "createdAtClient": "2025-01-28T15:42:00+03:00",
  "timezone": "Asia/Sakhalin",
  "producerCode": "PROD001",
  "producerName": "прод1",
  "description": "Погружаемся в гастрономию с шефом Ивановым"
}
```

#### Ответ при успехе
```json
{
  "success": true,
  "data": {
    "id": "evt_123",
    "status": "draft",
    "uploadedAtServer": "2025-01-28T12:50:32.123Z"
  }
}
```

#### Ответ при ошибке валидации
```json
{
  "success": false,
  "errors": [
    {
      "field": "startApplicationsAt",
      "message": "Начало приема заявок (ti10) должно быть раньше окончания (ti20)"
    },
    {
      "field": "pricePerSeat",
      "message": "Цена за место должна быть больше 0"
    }
  ]
}
```
Код состояния: `400 Bad Request`.

### POST `/api/external/events/publish`
Публикация ранее загруженного черновика. Переводит мероприятие из статуса `draft` в `published`, делая его доступным всем пользователям платформы.

#### Пример запроса
```json
{
  "id": "evt_123",
  "producerCode": "PROD001"
}
```

#### Ответ при успехе
```json
{
  "success": true,
  "data": {
    "id": "evt_123",
    "status": "published",
    "publishedAt": "2025-01-28T12:50:32.123Z"
  }
}
```

#### Ответ при ошибке
```json
{
  "success": false,
  "errors": [
    {
      "field": "id",
      "message": "Мероприятие не найдено или уже опубликовано"
    }
  ]
}
```

**Ограничения:**
- Публиковать может только продюсер-владелец (по `producerCode`).
- Нельзя публиковать после наступления `ti20` (окончание приема заявок).
- Код состояния: `200` при успехе, `400` при ошибках валидации, `403` при нарушении прав, `409` если мероприятие уже опубликовано или прошла точка `ti20`.

## Правила валидации (перенесены с текущего фронта)
1. **Обязательные поля**: `title`, `authorName`, `location`, `seatLimit`, `pricePerSeat`, `startApplicationsAt`, `endApplicationsAt`, `startContractsAt`, `startAt`, `endAt`, `createdAtClient`, `timezone`, `producerCode`, `producerName`, `description`.
2. **Числовые ограничения**:
   - `seatLimit` — целое число > 0.
   - `pricePerSeat` — число > 0 (допускаем копейки).
3. **Последовательность контрольных точек** (фиксированная модель):
   - `t0` (создание) < `ti10` < `ti20` < `ti30` < `ti40` < `ti50`.
   - `ti10 < ti40`.
   - `ti40` обязателен.
4. **Производные значения**:
   - `priceTotal = seatLimit × pricePerSeat`.
   - Сервер сохраняет даты `createdAtClient`, `uploadedAtServer` и хранит массив контрольных точек в стандартном виде.
5. **Право владения**:
   - При обновлении идентификатор продюсера (`producerCode`) должен совпадать с владельцем существующего черновика.
6. **Формат дат**:
   - Все даты (`createdAtClient`, контрольные точки `ti10`–`ti50`) передаются строкой в ISO 8601 (`YYYY-MM-DDTHH:mm:ss±HH:mm`).
   - Сервер нормализует даты в UTC, но сохраняет `timezone` для корректного отображения в интерфейсе.
7. **Часовой пояс**:
   - `timezone` должен быть валидным IANA-идентификатором (например, `Asia/Sakhalin`, `Europe/Moscow`, `Asia/Vladivostok`).
   - Используется для расчета обратного отсчета и отображения текущего времени в интерфейсе.
8. **Содержательные поля**:
   - `title`, `authorName`, `location`, `producerName`, `description` должны быть непустыми строками после тримминга (минимум 1 символ).
9. **Ограничения по времени**:
   - После наступления `ti20` (окончание приема заявок) нельзя загружать новые черновики и нельзя публиковать существующие черновики.

## Коды ответов
Код | Ситуация
---|---
`200` | Успешное создание/обновление или публикация.
`400` | Ошибки валидации входных данных.
`401` | Будущее: авторизация не пройдена или ключ невалиден.
`403` | Нарушение права владения черновиком или попытка публикации не своего мероприятия.
`409` | Конфликт: мероприятие уже опубликовано или прошла точка `ti20` (нельзя публиковать/загружать).
`500` | Непредвиденная ошибка сервера.

## Демо-клиент для тестов
- Страница `pages/demo/external-upload.vue` (будет добавлена).
- Поля формы соответствуют схеме запроса.
- Отправка выполняется через `fetch` на `/api/external/events`.
- В ответе показываются JSON-данные сервера для контроля.

## План по виджетам (этап 2)
- Подготовить два варианта интеграции: iframe/Web Component для «из коробки» и JSON API для кастомных UI.
- Обеспечить передачу параметров авторизации/идентификации события.
- Наладить защиту персональных данных (персональная калькуляция видна только авторизованному участнику).
