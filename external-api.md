# Внешний API: загрузка мероприятий и мониторинг

## Назначение
- Принять готовые мероприятия от внешних сайтов через HTTP API и сохранить их в ядре системы мониторинга.
- Валидировать входные данные по тем же правилам, что действуют сегодня на внутреннем сайте.
- Вернуть понятные ответы об успехе либо о найденных ошибках.
- Обозначить дальнейшие шаги по встраиваемым виджетам мониторинга и персональной калькуляции.

## Аутентификация
- На первом этапе допускаем работу без авторизации (эндпоинт скрыт, используется только для интеграционных тестов).
- Запланировано: авторизация по ключу разработчика (`X-API-Key`) с привязкой к партнёру и ограничениям по правам.

## Базовые сущности
Поле | Тип | Обязательность | Описание
---|---|---|---
`title` | string | да | Название мероприятия.
`authorName` | string | да | Имя/псевдоним автора. Заполняется продюсером в свободной форме и отображается в интерфейсе без изменений.
`location` | string | да | Место проведения.
`seatLimit` | integer (>0) | да | Количество участников.
`pricePerSeat` | number (>0) | да | Цена одного места в рублях.
`startApplicationsAt` | ISO datetime | да | Контрольная точка `ti10`.
`endApplicationsAt` | ISO datetime | да | Контрольная точка `ti20`.
`startContractsAt` | ISO datetime | да | Контрольная точка `ti30`.
`startAt` | ISO datetime | да | Контрольная точка `ti40`, старт мероприятия.
`endAt` | ISO datetime | да | Контрольная точка `ti50`, окончание мероприятия.
`createdAtClient` | ISO datetime | да | Время, когда событие было создано на клиентском сайте (`t0`).
`timezone` | string (IANA) | да | Часовой пояс, в котором заданы контрольные точки (например, `Asia/Sakhalin`, `Europe/Moscow`). Используется для корректного отображения обратного отсчета и текущего времени в интерфейсе.
`producerCode` | string | да | Уникальный код продюсера (используется для прав доступа).
`producerName` | string | да | Отображаемое имя продюсера (как будет видно пользователям).
`description` | string | да | Краткое описание мероприятия.

> Фиксируем модель из семи точек: `t0` (создание), `ti10`, `ti20`, `ti30`, `ti40`, `ti50`, `uploadedAtServer`. Извещения остаются стандартными и не требуют загрузки отдельными структурами.

Дополнительно сервер рассчитывает:
- `priceTotal` = `seatLimit × pricePerSeat` (в копейках).
- `uploadedAtServer` = момент приема события (назначается автоматически).

### Статусы мероприятий и видимость
- **Черновик (`draft`)**: Мероприятие загружается в статусе черновика. Черновик виден только продюсеру-владельцу (по `producerCode`) для просмотра. Черновик можно многократно обновлять через API.
- **Опубликовано (`published`)**: После публикации мероприятие становится доступно всем пользователям платформы. Публикация выполняется отдельным запросом (см. эндпоинт `/api/external/events/publish`).

**Ограничения:**
- После наступления контрольной точки `ti20` (окончание приема заявок) нельзя загружать новые черновики и нельзя публиковать существующие черновики.

## Эндпоинты
### POST `/api/external/events`
Создание или обновление черновика мероприятия. При наличии `id` и совпадении владельца выполняется обновление. Если `id` отсутствует — создаем новый черновик.

**Важно:** Все мероприятия загружаются в статусе `draft` (черновик). Для публикации используйте отдельный эндпоинт `/api/external/events/publish`.

#### Пример запроса
```json
{
  "id": "evt_123",
  "title": "Кулинарный интенсив",
  "authorName": "Шеф Иванов",
  "location": "Москва, ул. Поварская, 12",
  "seatLimit": 12,
  "pricePerSeat": 7500,
  "startApplicationsAt": "2025-02-01T09:00:00+03:00",
  "endApplicationsAt": "2025-02-10T21:00:00+03:00",
  "startContractsAt": "2025-02-12T10:00:00+03:00",
  "startAt": "2025-02-20T12:00:00+03:00",
  "endAt": "2025-02-20T18:00:00+03:00",
  "createdAtClient": "2025-01-28T15:42:00+03:00",
  "timezone": "Asia/Sakhalin",
  "producerCode": "PROD001",
  "producerName": "прод1",
  "description": "Погружаемся в гастрономию с шефом Ивановым"
}
```

#### Ответ при успехе
```json
{
  "success": true,
  "data": {
    "id": "evt_123",
    "status": "draft",
    "uploadedAtServer": "2025-01-28T12:50:32.123Z"
  }
}
```

#### Ответ при ошибке валидации
```json
{
  "success": false,
  "errors": [
    {
      "field": "startApplicationsAt",
      "message": "Начало приема заявок (ti10) должно быть раньше окончания (ti20)"
    },
    {
      "field": "pricePerSeat",
      "message": "Цена за место должна быть больше 0"
    }
  ]
}
```
Код состояния: `400 Bad Request`.

### POST `/api/external/events/publish`
Публикация ранее загруженного черновика. Переводит мероприятие из статуса `draft` в `published`, делая его доступным всем пользователям платформы.

#### Пример запроса
```json
{
  "id": "evt_123",
  "producerCode": "PROD001"
}
```

#### Ответ при успехе
```json
{
  "success": true,
  "data": {
    "id": "evt_123",
    "status": "published",
    "publishedAt": "2025-01-28T12:50:32.123Z"
  }
}
```

#### Ответ при ошибке
```json
{
  "success": false,
  "errors": [
    {
      "field": "id",
      "message": "Мероприятие не найдено или уже опубликовано"
    }
  ]
}
```

**Ограничения:**
- Публиковать может только продюсер-владелец (по `producerCode`).
- Нельзя публиковать после наступления `ti20` (окончание приема заявок).
- Код состояния: `200` при успехе, `400` при ошибках валидации, `403` при нарушении прав, `409` если мероприятие уже опубликовано или прошла точка `ti20`.

## Правила валидации (перенесены с текущего фронта)
1. **Обязательные поля**: `title`, `authorName`, `location`, `seatLimit`, `pricePerSeat`, `startApplicationsAt`, `endApplicationsAt`, `startContractsAt`, `startAt`, `endAt`, `createdAtClient`, `timezone`, `producerCode`, `producerName`, `description`.
2. **Числовые ограничения**:
   - `seatLimit` — целое число > 0.
   - `pricePerSeat` — число > 0 (допускаем копейки).
3. **Последовательность контрольных точек** (фиксированная модель):
   - `t0` (создание) < `ti10` < `ti20` < `ti30` < `ti40` < `ti50`.
   - `ti10 < ti40`.
   - `ti40` обязателен.
4. **Производные значения**:
   - `priceTotal = seatLimit × pricePerSeat`.
   - Сервер сохраняет даты `createdAtClient`, `uploadedAtServer` и хранит массив контрольных точек в стандартном виде.
5. **Право владения**:
   - При обновлении идентификатор продюсера (`producerCode`) должен совпадать с владельцем существующего черновика.
6. **Формат дат**:
   - Все даты (`createdAtClient`, контрольные точки `ti10`–`ti50`) передаются строкой в ISO 8601 (`YYYY-MM-DDTHH:mm:ss±HH:mm`).
   - Сервер нормализует даты в UTC, но сохраняет `timezone` для корректного отображения в интерфейсе.
7. **Часовой пояс**:
   - `timezone` должен быть валидным IANA-идентификатором (например, `Asia/Sakhalin`, `Europe/Moscow`, `Asia/Vladivostok`).
   - Используется для расчета обратного отсчета и отображения текущего времени в интерфейсе.
8. **Содержательные поля**:
   - `title`, `authorName`, `location`, `producerName`, `description` должны быть непустыми строками после тримминга (минимум 1 символ).
9. **Ограничения по времени**:
   - После наступления `ti20` (окончание приема заявок) нельзя загружать новые черновики и нельзя публиковать существующие черновики.

## Коды ответов
Код | Ситуация
---|---
`200` | Успешное создание/обновление или публикация.
`400` | Ошибки валидации входных данных.
`401` | Будущее: авторизация не пройдена или ключ невалиден.
`403` | Нарушение права владения черновиком или попытка публикации не своего мероприятия.
`409` | Конфликт: мероприятие уже опубликовано или прошла точка `ti20` (нельзя публиковать/загружать).
`500` | Непредвиденная ошибка сервера.

## Демо-клиент для тестов
- Страница `pages/demo/external-upload.vue` (будет добавлена).
- Поля формы соответствуют схеме запроса.
- Отправка выполняется через `fetch` на `/api/external/events`.
- В ответе показываются JSON-данные сервера для контроля.

### GET `/api/external/events/{id}/monitoring`
Получение данных мониторинга мероприятия после наступления контрольной точки `ti20` (окончание приема заявок).

**Требования:**
- Мероприятие должно быть загружено на платформу (иметь статус `draft` или `published`).
- Должна пройти контрольная точка `ti20` (окончание приема заявок).
- Необходима авторизация через API-ключ (заголовок `Authorization: Bearer {apiKey}`).

#### Пример запроса
```http
GET /api/external/events/evt_123/monitoring
Authorization: Bearer your_api_key_here
```

#### Ответ при успехе
```json
{
  "success": true,
  "data": {
    "eventId": "evt_123",
    "nowPoint": "ti20",
    "collected": 900000,
    "deficit": 0,
    "surplus": 0,
    "isCancelled": false,
    "applicants": [
      {
        "code": "user_001",
        "login": "user1@example.com",
        "seats": 1,
        "paidAmount": 75000,
        "payments": [
          {
            "amount": 75000,
            "createdAt": "2025-02-10T10:30:00Z",
            "paymentId": "pay_123",
            "status": "completed"
          }
        ]
      },
      {
        "code": "user_002",
        "login": "user2@example.com",
        "seats": 2,
        "paidAmount": 150000,
        "payments": [
          {
            "amount": 150000,
            "createdAt": "2025-02-10T11:15:00Z",
            "paymentId": "pay_124",
            "status": "completed"
          }
        ]
      }
    ],
    "deadlineNext": "2025-02-12T10:00:00Z",
    "personalCalculations": [
      {
        "applicantCode": "user_001",
        "applicantLogin": "user1@example.com",
        "status": "success",
        "expectedPayment": 75000,
        "totalPaid": 75000,
        "extraContribution": 0,
        "deficit": 0,
        "share": 0.5,
        "refundFromSurplus": 0,
        "refundTotal": 0,
        "pricePerSeat": 75000,
        "surplusAvailable": 0,
        "overflowTotal": 0
      },
      {
        "applicantCode": "user_002",
        "applicantLogin": "user2@example.com",
        "status": "success",
        "expectedPayment": 150000,
        "totalPaid": 150000,
        "extraContribution": 0,
        "deficit": 0,
        "share": 0.5,
        "refundFromSurplus": 0,
        "refundTotal": 0,
        "pricePerSeat": 75000,
        "surplusAvailable": 0,
        "overflowTotal": 0
      }
    ]
  }
}
```

#### Структура ответа мониторинга

**Основные поля:**
- `eventId` (string) — идентификатор мероприятия.
- `nowPoint` (string) — текущая контрольная точка (`ti10`, `ti20`, `ti30`, `ti40`, `ti50`, `t999`).
- `collected` (number, опционально) — общая сумма собранных средств в копейках.
- `deficit` (number, опционально) — дефицит средств в копейках (если сбор не состоялся).
- `surplus` (number, опционально) — профицит средств в копейках (если собрано больше целевой суммы).
- `isCancelled` (boolean, опционально) — флаг отмены мероприятия.
- `applicants` (array) — массив заявителей (см. ниже).
- `deadlineNext` (string, опционально) — следующая контрольная точка в формате ISO datetime.
- `personalCalculations` (array, опционально) — **готовые персональные расчеты для всех участников** (см. ниже).

**Структура заявителя (`Applicant`):**
- `code` (string) — уникальный код заявителя.
- `login` (string, опционально) — логин/email заявителя.
- `seats` (number) — количество мест, на которые подал заявку заявитель.
- `paidAmount` (number) — общая сумма оплаты в копейках.
- `payments` (array, опционально) — массив платежей:
  - `amount` (number) — сумма платежа в копейках.
  - `createdAt` (string) — дата и время платежа в формате ISO datetime.
  - `paymentId` (string, опционально) — идентификатор платежа.
  - `status` (string, опционально) — статус платежа.

**Структура персонального расчета (`PersonalCalculation`):**
Все расчеты выполняются **на сервере платформы**. Клиентский сайт только отображает готовые данные.

- `applicantCode` (string) — код заявителя.
- `applicantLogin` (string, опционально) — логин заявителя.
- `status` (string) — статус расчета:
  - `"success"` — заявитель успешно вошел в лимит мест.
  - `"overflow"` — заявитель не вошел в лимит (сверх лимита).
  - `"failed"` — сбор не состоялся (недостаточно средств).
- `expectedPayment` (number, опционально) — ожидаемый платеж в копейках (минимальный взнос).
- `totalPaid` (number) — фактически внесено в копейках.
- `extraContribution` (number, опционально) — переплата в копейках.
- `deficit` (number, опционально) — недоплата в копейках.
- `share` (number, опционально) — доля в распределении профицита (от 0 до 1).
- `refundFromSurplus` (number, опционально) — возврат из профицита в копейках.
- `refundTotal` (number) — **итого к возврату в копейках**.
- `pricePerSeat` (number, опционально) — цена за место в копейках.
- `surplusAvailable` (number, опционально) — доступный профицит для распределения в копейках.
- `overflowTotal` (number, опционально) — сумма возврата сверхлимитчикам в копейках.

**Для статуса `"overflow"` дополнительно:**
- `reason` (string, опционально) — причина выхода за лимит:
  - `"lower"` — меньшая сумма платежа.
  - `"late"` — поздний платеж (при той же сумме).
- `thresholdAmount` (number | null, опционально) — пороговая ставка в копейках.
- `thresholdTime` (number | null, опционально) — время порогового платежа (timestamp в миллисекундах).
- `selectedTime` (number | null, опционально) — время платежа участника (timestamp в миллисекундах).

#### Ответ при ошибке
```json
{
  "success": false,
  "errors": [
    {
      "field": "id",
      "message": "Мероприятие не найдено или контрольная точка ti20 еще не наступила"
    }
  ]
}
```

**Коды состояния:**
- `200` — успешный запрос.
- `400` — ошибки валидации (например, ti20 еще не наступила).
- `401` — авторизация не пройдена или ключ невалиден.
- `403` — нет доступа к данному мероприятию.
- `404` — мероприятие не найдено.
- `500` — непредвиденная ошибка сервера.

**Важно:**
- Все персональные расчеты выполняются **на сервере платформы** после наступления `ti20`.
- Клиентский сайт (демо) **не должен** выполнять расчеты самостоятельно — только отображать готовые данные из `personalCalculations`.
- Если `personalCalculations` отсутствует в ответе, это означает, что расчеты еще не выполнены или произошла ошибка.


